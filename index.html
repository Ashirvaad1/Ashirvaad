<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Delightful Notes</title>
		<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
		<link href="styles.css" rel="stylesheet">
	</head>
	<body>
		<div class="container">
			<h1 class="title">Personal Diary</h1>
			<hr color="#6200ea">
			<div id="notes-container" class="notes-container">
				<div id="notes-list" class="notes-list"></div>
			</div>
			<button id="write-btn" class="write-btn">✍️</button>
			<div id="write-modal" class="write-modal">
				<div class="modal-content">
					<h2 class="modal-title">Today's Note</h2>
					<textarea id="note-input" class="note-input" rows="5" placeholder="Start here..."></textarea>
					<div class="visibility-toggle">
						<label for="visibility-checkbox">Make Visible</label>
						<input type="checkbox" id="visibility-checkbox" checked/>
					</div>
					<div class="modal-actions">
						<button id="save-btn" class="save-btn">Save</button>
					</div>
				</div>
			</div>
		</div>
		<script type="module">
			import
			{
				initializeApp
			}
				from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
			import
			{
				getFirestore, collection, addDoc, getDocs, query, where, orderBy, startAfter, limit,
			}
				from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";
			const firebaseConfig=
			{
				apiKey: "AIzaSyBIsQtSpCCA1QDks8K6WpDe1jXppMtwVOs",
				authDomain: "notes-81643.firebaseapp.com",
				projectId: "notes-81643",
				storageBucket: "notes-81643.appspot.com",
				messagingSenderId: "896217476176",
				appId: "1:896217476176:web:02bb0d8fe5dae50519f555",
				measurementId: "G-PVHEPSRWML",
			};
			const app=initializeApp(firebaseConfig);
			const db=getFirestore(app);
			const writeBtn=document.getElementById("write-btn");
			const writeModal=document.getElementById("write-modal");
			const noteInput=document.getElementById("note-input");
			const saveBtn=document.getElementById("save-btn");
			const visibilityCheckbox=document.getElementById("visibility-checkbox");
			const notesList=document.getElementById("notes-list");
			writeBtn.addEventListener("click", ()=>
				{
					writeModal.classList.add("show");
				});
			document.addEventListener("click", (e)=>
				{
					if(e.target!==writeModal && e.target!==writeBtn && !writeModal.contains(e.target))
					{
						writeModal.classList.remove("show");
					}
				});
			saveBtn.addEventListener("click", async()=>
				{
					const noteContent=noteInput.value.trim();
					const isVisible=visibilityCheckbox.checked?"visible":"hidden";
					if(noteContent!=="")
					{
						if(noteContent==="Life")
						{
							loadHiddenNotes();
						}
						else
						{
							await addDoc(collection(db, "notes"),
								     {
									     content: noteContent, visibility: isVisible, date: formatDate(new Date()), timestamp: new Date()
								     });
							//notesList.innerHTML="";
							loadNotes();
						}
						noteInput.value="";
						visibilityCheckbox.checked=true;
						writeModal.classList.remove("show");
					}
				});
			function formatDate(date)
			{
				const day=date.getDate();
				const month=date.getMonth()+1;
				const year=date.getFullYear();
				const hours=date.getHours();
				const minutes=date.getMinutes();
				const ampm=hours>=12?"p.m.":"a.m.";
				const hours12=hours%12 || 12;
				return `${day}.${month}.${year} ${hours12}:${minutes} ${ampm}`;
			}
			let lastVisible=null;
			let isLoading=false;
			const loadNotes=async()=>
				{
					const notesQuery=query(collection(db, "notes"), where("visibility", "==", "visible"), orderBy("timestamp", "desc"));
					const querySnapshot=await getDocs(notesQuery);
					querySnapshot.forEach((doc)=>
						{
							const data=doc.data();
							const noteElement=document.createElement("div");
							noteElement.classList.add("note");
							noteElement.innerHTML=`<p>${data.content}</p><p style="float:right;">${data.date}</p><br>`;
							notesList.appendChild(noteElement);
						});
				};
			const loadHiddenNotes=async()=>
				{
					const hiddenNotesQuery=query(collection(db, "notes"), where("visibility", "==", "hidden"), orderBy("timestamp", "desc"));
					const querySnapshot=await getDocs(hiddenNotesQuery);
					querySnapshot.forEach((doc)=>
						{
							const data=doc.data();
							const noteElement=document.createElement("div");
							noteElement.classList.add("note");
							noteElement.innerHTML=`<p>${data.content}</p><p style="float:right;">${data.date}</p><br>`;
							notesList.appendChild(noteElement);
						});
				};
			loadNotes();
		</script>
	</body>
</html>
